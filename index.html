<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-950">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Command | Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .nav-item.active { background-color: #1e293b; color: #fff; border-right: 3px solid #3b82f6; }
        .editor-tab.active { border-bottom: 2px solid #3b82f6; color: white; }
        .editor-tab { color: #64748b; border-bottom: 2px solid transparent; }
        .editor-tab:hover { color: #94a3b8; }
    </style>
</head>
<body x-data="app()" x-init="initApp()" class="flex h-full overflow-hidden text-slate-200 selection:bg-blue-500 selection:text-white">

    <script>
        // -----------------------------------------------------------
        // ‚ö†Ô∏è PASTE YOUR FIREBASE CONFIG HERE
        // -----------------------------------------------------------
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB-P87cAnvDHpCoPocqhjHE9zGaDQXxe2U",
  authDomain: "balance-t.firebaseapp.com",
  databaseURL: "https://balance-t-default-rtdb.firebaseio.com",
  projectId: "balance-t",
  storageBucket: "balance-t.firebasestorage.app",
  messagingSenderId: "893924100931",
  appId: "1:893924100931:web:70427b3ff655341594fdf6",
  measurementId: "G-5RJM9SQDS1"
};
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const APP_ID = "web"; 
        const COLLECTIONS = {
            ACTIVE: `artifacts/${APP_ID}/public/data/activeDrivers`,
            ROSTER: `artifacts/${APP_ID}/public/data/driverRoster`,
            REGIONS: `artifacts/${APP_ID}/public/data/regions`
        };
    </script>

    <aside class="w-72 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800 bg-slate-900/50">
            <h1 class="text-lg font-bold text-white tracking-tight">FLEET COMMAND</h1>
        </div>

        <nav class="flex-1 overflow-y-auto custom-scroll py-6 px-3 space-y-1">
            <button @click="currentTab = 'dashboard'" :class="currentTab === 'dashboard' ? 'bg-blue-600/10 text-blue-400 border-blue-600' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-transparent'" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg border-l-4 transition-all">
                <span>üìç Live Map</span>
            </button>
            <div x-show="currentTab === 'dashboard'" x-transition class="pl-11 pr-2 space-y-1 pb-4">
                <button @click="setDashboardFilter('All')" :class="dashboardFilter === 'All' ? 'text-white font-semibold' : 'text-slate-500 hover:text-slate-300'" class="block w-full text-left text-xs py-1.5 transition">All Regions</button>
                <template x-for="region in regions" :key="region.id">
                    <button @click="setDashboardFilter(region.id)" :class="dashboardFilter === region.id ? 'text-white font-semibold' : 'text-slate-500 hover:text-slate-300'" class="block w-full text-left text-xs py-1.5 transition" x-text="region.name"></button>
                </template>
            </div>
            <button @click="currentTab = 'profiles'" :class="currentTab === 'profiles' ? 'bg-blue-600/10 text-blue-400 border-blue-600' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-transparent'" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg border-l-4 transition-all">
                <span>üë• Fleet Roster</span>
            </button>
            <button @click="currentTab = 'export'" :class="currentTab === 'export' ? 'bg-blue-600/10 text-blue-400 border-blue-600' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-transparent'" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg border-l-4 transition-all">
                <span>üìâ Reports</span>
            </button>
            <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'bg-blue-600/10 text-blue-400 border-blue-600' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-transparent'" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg border-l-4 transition-all">
                <span>‚öôÔ∏è Admin</span>
            </button>
        </nav>
        
        <div class="p-4 bg-slate-950/50 border-t border-slate-800">
            <div class="flex items-center gap-2">
                <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span>
                <span class="text-[10px] font-mono text-slate-500 uppercase tracking-wider">System Online</span>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative">

        <div x-show="currentTab === 'dashboard'" class="flex-1 flex flex-col h-full">
            <div class="bg-slate-900/50 border-b border-slate-800 p-6 flex justify-between items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-white" x-text="dashboardFilter === 'All' ? 'All Regions' : getRegionName(dashboardFilter)"></h2>
                    <p class="text-sm text-slate-500">Real-time fleet operations monitoring</p>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 shadow-lg">
                    <div class="text-xs text-slate-500 uppercase font-bold tracking-wider">Active Units</div>
                    <div class="text-2xl font-bold text-white leading-none mt-1" x-text="filteredDrivers.length">--</div>
                </div>
            </div>

            <div class="px-6 pt-6 shrink-0">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><span>üìä</span> Live Shift Hours</h3>
                <div class="flex gap-4 overflow-x-auto custom-scroll pb-2">
                    <template x-for="(hours, regionName) in regionStats" :key="regionName">
                        <div class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 min-w-[140px] shrink-0 shadow-sm">
                            <div class="text-[10px] text-slate-400 uppercase font-bold truncate" x-text="regionName"></div>
                            <div class="text-xl font-bold text-white"><span x-text="hours.toFixed(1)"></span> <span class="text-xs text-slate-500 font-normal">hrs</span></div>
                        </div>
                    </template>
                    <div x-show="Object.keys(regionStats).length === 0" class="text-xs text-slate-600 italic">No active data available.</div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                <div class="bg-slate-900 rounded-xl overflow-hidden shadow-lg border border-slate-800">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-950 text-slate-400 text-xs uppercase font-bold tracking-wider border-b border-slate-800">
                            <tr>
                                <th class="p-4">Driver Name</th>
                                <th class="p-4">Vehicle</th>
                                <th class="p-4">Region</th>
                                <th class="p-4 text-right">Shift Progress</th>
                                <th class="p-4 text-right">Duration</th>
                                <th class="p-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800/50 text-sm">
                            <template x-for="driver in filteredDrivers" :key="driver.id">
                                <tr class="hover:bg-slate-800/50 transition duration-150" :style="getProgressStyle(driver)">
                                    <td class="p-4 font-bold text-white" x-text="getDriverName(driver.id)"></td>
                                    <td class="p-4 text-blue-300 font-mono" x-text="driver.vehicle_number || driver.vehicle || 'N/A'"></td>
                                    <td class="p-4 text-emerald-300" x-text="getRegionName(getDriverRegionID(driver))"></td>
                                    <td class="p-4 text-right text-slate-400 font-mono">
                                        <div class="flex flex-col items-end"><span class="text-white" x-text="formatTime(driver.login_time)"></span><span class="text-[10px] text-slate-600 uppercase">Start</span></div>
                                    </td>
                                    <td class="p-4 text-right text-white font-mono" x-text="calculateDuration(driver.login_time)"></td>
                                    <td class="p-4 text-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">Active</span></td>
                                </tr>
                            </template>
                            <tr x-show="filteredDrivers.length === 0"><td colspan="6" class="p-12 text-center text-slate-500 italic">No active drivers found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'profiles'" class="flex-1 flex h-full">
            <div class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0">
                <div class="p-4 border-b border-slate-800 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-white">Driver Database</h3>
                        <span class="text-xs text-slate-500" x-text="filteredRoster.length + ' Drivers'"></span>
                    </div>
                    <div class="relative">
                        <input type="text" x-model="searchQuery" placeholder="Search drivers..." class="w-full bg-slate-950 border border-slate-700 rounded-lg py-2 pl-3 pr-10 text-sm text-white placeholder-slate-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1">
                    <template x-for="driver in filteredRoster" :key="driver.id">
                        <div @click="selectDriver(driver.id)" class="p-3 rounded-lg cursor-pointer transition group border-l-2" :class="selectedDriverId === driver.id ? 'bg-blue-600/20 border-blue-500' : 'bg-slate-800/30 border-transparent hover:bg-slate-800'">
                            <div class="flex justify-between items-center mb-1">
                                <div class="font-bold text-sm text-white" x-text="driver.name || driver.id"></div>
                                <div class="text-[10px] text-slate-500" x-text="getRegionName(getDriverRegionID(driver))"></div>
                            </div>
                            <div class="text-xs text-slate-500 font-mono" x-text="'ID: ' + driver.id"></div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex-1 bg-slate-950 flex flex-col relative overflow-hidden">
                <div x-show="!selectedDriverId" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600">
                    <span class="text-6xl mb-4">üë§</span>
                    <p>Select a driver to view details</p>
                </div>

                <div x-show="selectedDriverId" class="flex flex-col h-full">
                    <div class="p-8 border-b border-slate-800 bg-slate-900/50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold text-white" x-text="editForm.name || 'Driver ' + selectedDriverId"></h2>
                                <p class="text-xs text-slate-500 font-mono mt-1" x-text="'ID: ' + selectedDriverId"></p>
                            </div>
                            <div x-show="isActive(selectedDriverId)" class="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Active Now
                            </div>
                        </div>
                        <div class="flex gap-8 mt-8 border-b border-slate-800/50">
                            <button @click="editorTab = 'settings'" :class="editorTab === 'settings' ? 'text-blue-400 border-blue-500' : 'text-slate-400 border-transparent hover:text-white'" class="pb-3 text-sm font-bold uppercase tracking-wide border-b-2 transition">Settings</button>
                            <button @click="editorTab = 'history'" :class="editorTab === 'history' ? 'text-blue-400 border-blue-500' : 'text-slate-400 border-transparent hover:text-white'" class="pb-3 text-sm font-bold uppercase tracking-wide border-b-2 transition">Trip History</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll p-8">
                        
                        <div x-show="editorTab === 'settings'" class="max-w-3xl space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div><label class="block text-xs uppercase text-slate-500 font-bold mb-1">Full Name</label><input type="text" x-model="editForm.name" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-blue-500 outline-none"></div>
                                <div><label class="block text-xs uppercase text-slate-500 font-bold mb-1">Default Vehicle</label><input type="text" x-model="editForm.vehicle" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-blue-500 outline-none"></div>
                            </div>
                            <div>
                                <label class="block text-xs uppercase text-slate-500 font-bold mb-1">Assigned Region</label>
                                <select x-model="editForm.region" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-blue-500 outline-none">
                                    <option value="">-- Select Region --</option>
                                    <template x-for="r in regions" :key="r.id"><option :value="r.id" x-text="r.name"></option></template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs uppercase text-red-400 font-bold mb-1">Alert / Notes</label>
                                <textarea x-model="editForm.note" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-red-500 outline-none h-24"></textarea>
                            </div>
                            <div class="pt-6 border-t border-slate-800 flex justify-between items-center">
                                <button x-show="isActive(selectedDriverId)" @click="forceSignOut()" class="text-red-400 text-sm font-bold hover:text-red-300">‚õî Force Sign Out</button>
                                <button @click="saveDriver()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded shadow-lg transition">Save Changes</button>
                            </div>
                        </div>

                        <div x-show="editorTab === 'history'">
                            <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 mb-6">
                                <div class="flex justify-between items-end mb-4">
                                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Last 7 Days Activity</h3>
                                    <div class="text-2xl font-bold text-white">
                                        <span x-text="weeklyStats.total.toFixed(1)"></span> <span class="text-sm text-slate-500 font-normal">hrs total</span>
                                    </div>
                                </div>
                                <div class="flex items-end justify-between h-32 gap-2">
                                    <template x-for="day in weeklyStats.days">
                                        <div class="flex flex-col items-center w-full gap-2 group relative h-full justify-end">
                                           <div x-show="day.hours > 0" class="absolute -top-8 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition shadow-lg border border-slate-700" x-text="day.hours.toFixed(1) + 'h'"></div>
                                           <div class="w-full bg-slate-800/50 rounded-sm relative flex-1 flex items-end overflow-hidden" style="height: 100%">
                                               <div class="w-full rounded-sm transition-all duration-700" 
                                                    :class="day.hours > 8 ? 'bg-emerald-500' : 'bg-blue-600'"
                                                    :style="'height: ' + day.pct + '%'"></div>
                                           </div>
                                           <span class="text-[10px] text-slate-500 uppercase font-bold" x-text="day.label"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-lg">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-950 text-slate-400 text-xs uppercase border-b border-slate-800">
                                        <tr><th class="p-4">Date</th><th class="p-4">Duration</th><th class="p-4">Vehicle</th><th class="p-4">Site</th><th class="p-4 w-1/3">Notes</th></tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800">
                                        <template x-for="log in driverHistory" :key="log.id">
                                            <tr class="hover:bg-slate-900/50">
                                                <td class="p-4"><div class="font-bold text-white" x-text="formatDate(log.login_time)"></div><div class="text-xs text-slate-500" x-text="formatTimeRange(log.login_time, log.logout_time)"></div></td>
                                                <td class="p-4">
                                                    <div class="flex items-center gap-2">
                                                        <div class="h-1.5 w-16 bg-slate-800 rounded-full overflow-hidden"><div class="h-full rounded-full" :class="getDurationColor(log.duration)" :style="'width: ' + Math.min(log.duration / 12 * 100, 100) + '%'"></div></div>
                                                        <span class="text-xs text-slate-300" x-text="log.duration.toFixed(1) + ' hrs'"></span>
                                                    </div>
                                                </td>
                                                <td class="p-4 text-slate-400 font-mono" x-text="log.vehicle"></td>
                                                <td class="p-4 text-emerald-400" x-text="getRegionName(getDriverRegionID(log))"></td>
                                                <td class="p-4"><input type="text" x-model="log.note" @blur="saveHistoryNote(log.id, log.note)" class="bg-transparent w-full text-slate-300 placeholder-slate-600 focus:outline-none border-b border-transparent focus:border-blue-500 transition" placeholder="Add note..."></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'export'" class="flex-1 p-8 overflow-y-auto custom-scroll">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-white mb-8 flex items-center gap-3"><span class="text-3xl">üìâ</span> Data Export Center</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-8 shadow-xl">
                        <h3 class="text-xl font-bold text-blue-400 mb-2">Daily Fleet Log</h3>
                        <p class="text-sm text-slate-400 mb-6">Download all shift logs for a specific day.</p>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label><input type="date" x-model="exportForm.dailyDate" class="w-full bg-slate-950 border border-slate-700 rounded p-2.5 text-white outline-none focus:border-blue-500"></div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Region</label>
                                    <select x-model="exportForm.dailyRegion" class="w-full bg-slate-950 border border-slate-700 rounded p-2.5 text-white outline-none focus:border-blue-500">
                                        <option value="All">All Regions</option>
                                        <template x-for="r in regions" :key="r.id"><option :value="r.id" x-text="r.name"></option></template>
                                    </select>
                                </div>
                            </div>
                            <button @click="generateDailyReport" :disabled="isExporting" class="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white font-bold py-3 rounded transition flex justify-center items-center gap-2"><span x-show="!isExporting">‚¨áÔ∏è Download Report</span><span x-show="isExporting">Processing...</span></button>
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-8 shadow-xl">
                        <h3 class="text-xl font-bold text-emerald-400 mb-2">Driver History</h3>
                        <p class="text-sm text-slate-400 mb-6">Export timesheets for a single driver.</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Driver</label>
                                <select x-model="exportForm.driverId" class="w-full bg-slate-950 border border-slate-700 rounded p-2.5 text-white outline-none focus:border-emerald-500">
                                    <option value="">-- Select Driver --</option>
                                    <template x-for="d in roster" :key="d.id"><option :value="d.id" x-text="d.name || d.id"></option></template>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start</label><input type="date" x-model="exportForm.startDate" class="w-full bg-slate-950 border border-slate-700 rounded p-2.5 text-white outline-none focus:border-emerald-500"></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">End</label><input type="date" x-model="exportForm.endDate" class="w-full bg-slate-950 border border-slate-700 rounded p-2.5 text-white outline-none focus:border-emerald-500"></div>
                            </div>
                            <button @click="generateDriverReport" :disabled="isExporting" class="w-full bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 text-white font-bold py-3 rounded transition flex justify-center items-center gap-2"><span x-show="!isExporting">‚¨áÔ∏è Download History</span><span x-show="isExporting">Processing...</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'settings'" class="flex-1 p-8 overflow-y-auto custom-scroll">
            <div class="max-w-4xl mx-auto space-y-8">
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white">Region Management</h3>
                        <button @click="regionModalOpen = true" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded shadow-lg text-sm">+ Add Region</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <template x-for="r in regions" :key="r.id">
                            <div class="bg-slate-800 border border-slate-700 p-4 rounded-lg flex justify-between items-center">
                                <div><div class="font-bold text-white" x-text="r.name"></div><div class="text-xs text-slate-500 font-mono" x-text="r.id"></div></div>
                                <button @click="deleteRegion(r.id)" class="text-red-400 hover:text-white text-xs font-bold">Delete</button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div x-show="regionModalOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" @click="regionModalOpen = false"></div>
        <div class="relative bg-slate-900 border border-slate-700 p-8 rounded-xl w-full max-w-md shadow-2xl" @click.stop>
            <h2 class="text-xl font-bold text-white mb-6">Add Region</h2>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Webhook ID</label><input x-model="newRegion.id" type="text" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Display Name</label><input x-model="newRegion.name" type="text" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white"></div>
                <button @click="saveRegion()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded">Save Region</button>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // State
                currentTab: 'dashboard',
                mobileMenuOpen: false,
                dashboardFilter: 'All',
                regions: [],
                activeDrivers: [],
                roster: [],
                selectedDriverId: null,
                editorTab: 'settings',
                driverHistory: [],
                regionModalOpen: false,
                isExporting: false,
                searchQuery: '',
                editForm: { name: '', vehicle: '', note: '', region: '' },
                newRegion: { id: '', name: '' },
                exportForm: {
                    dailyDate: new Date().toISOString().split('T')[0],
                    dailyRegion: 'All',
                    driverId: '',
                    startDate: new Date(new Date().setDate(new Date().getDate()-7)).toISOString().split('T')[0],
                    endDate: new Date().toISOString().split('T')[0]
                },

                // Computed
                get filteredDrivers() {
                    return this.activeDrivers.filter(d => {
                        const r = this.getDriverRegionID(d);
                        return this.dashboardFilter === 'All' || r === this.dashboardFilter;
                    });
                },
                get regionStats() {
                    const stats = {};
                    const now = new Date();
                    this.activeDrivers.forEach(d => {
                        const rID = this.getDriverRegionID(d);
                        const rName = this.getRegionName(rID);
                        const start = this.toDate(d.login_time);
                        if(start) {
                            const hrs = (now - start) / 3600000;
                            stats[rName] = (stats[rName] || 0) + hrs;
                        }
                    });
                    return stats;
                },
                get weeklyStats() {
                    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    const buckets = days.map(label => ({ label, hours: 0, pct: 0 }));
                    const now = new Date();
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(now.getDate() - 7);
                    let total = 0;
                    let max = 0;

                    this.driverHistory.forEach(log => {
                        const start = this.toDate(log.login_time);
                        if (start && start >= sevenDaysAgo) {
                            let dayIdx = start.getDay() - 1; 
                            if (dayIdx === -1) dayIdx = 6; 
                            buckets[dayIdx].hours += log.duration;
                            total += log.duration;
                        }
                    });

                    buckets.forEach(b => { if(b.hours > max) max = b.hours; });
                    buckets.forEach(b => { b.pct = max > 0 ? (b.hours / max) * 100 : 0; });
                    return { days: buckets, total };
                },
                get filteredRoster() {
                    const q = this.searchQuery.toLowerCase();
                    return this.roster.filter(d => {
                        const name = d.name ? d.name.toLowerCase() : '';
                        const id = d.id.toLowerCase();
                        return name.includes(q) || id.includes(q);
                    });
                },

                // Helpers
                initApp() {
                    db.collection(COLLECTIONS.REGIONS).onSnapshot(s => this.regions = s.docs.map(d => ({id: d.id, ...d.data()})) );
                    db.collection(COLLECTIONS.ACTIVE).onSnapshot(s => this.activeDrivers = s.docs.map(d => ({id: d.id, ...d.data()})) );
                    db.collection(COLLECTIONS.ROSTER).onSnapshot(s => this.roster = s.docs.map(d => ({id: d.id, ...d.data()})) );
                },
                toDate(val) {
                    if(!val) return null;
                    if(val.toDate) return val.toDate();
                    const d = new Date(val);
                    return isNaN(d.getTime()) ? null : d;
                },
                // THE MAGIC FIX: CATCH-ALL KEY CHECK
                getDriverRegionID(d) {
                    return d.Driversite || d.site_id || d.region_id || d.site || d.region || 'Unassigned';
                },
                getRegionName(id) {
                    const r = this.regions.find(x => x.id === id);
                    return r ? r.name : (id || 'Unknown');
                },
                getDriverName(id) {
                    const d = this.roster.find(x => x.id === id);
                    return d && d.name ? d.name : id;
                },
                formatTime(val) {
                    const d = this.toDate(val);
                    return d ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
                },
                formatDate(val) {
                    const d = this.toDate(val);
                    return d ? d.toLocaleDateString() : '--';
                },
                formatTimeRange(start, end) {
                    const s = this.toDate(start);
                    const e = this.toDate(end);
                    if(!s) return '--';
                    const t1 = s.toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'});
                    const t2 = e ? e.toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}) : 'Active';
                    return `${t1} - ${t2}`;
                },
                calculateDuration(start) {
                    const s = this.toDate(start);
                    if(!s) return '--';
                    const diff = (new Date() - s) / 3600000;
                    const hrs = Math.floor(diff);
                    const mins = Math.floor((diff % 1) * 60);
                    return `${hrs}h ${mins}m`;
                },
                getProgressStyle(driver) {
                    const start = this.toDate(driver.login_time);
                    if(!start) return '';
                    const elapsed = new Date() - start;
                    let pct = (elapsed / 28800000) * 100; 
                    let color = '#10b981'; 
                    if(pct > 100) { pct = 100; color = '#ef4444'; }
                    return `background: linear-gradient(to right, ${color} ${pct}%, transparent ${pct}%) no-repeat bottom; background-size: 100% 2px;`;
                },
                getDurationColor(hrs) {
                    if(hrs > 10) return 'bg-red-500';
                    if(hrs > 8) return 'bg-yellow-500';
                    return 'bg-blue-500';
                },
                isActive(id) { return this.activeDrivers.some(d => d.id === id); },

                // Actions
                setDashboardFilter(id) { this.dashboardFilter = id; },
                selectDriver(id) {
                    this.selectedDriverId = id;
                    const driver = this.roster.find(d => d.id === id) || {};
                    this.editForm = {
                        name: driver.name || '',
                        vehicle: driver.vehicle || '',
                        note: driver.alert_note || '',
                        region: this.getDriverRegionID(driver) || '' // Use safe getter
                    };
                    this.loadHistory(id);
                },
                async loadHistory(id) {
                    const snap = await db.collection(COLLECTIONS.ROSTER).doc(id).collection("shiftHistory")
                        .orderBy("login_time", "desc").limit(50).get();
                    const now = new Date();
                    this.driverHistory = snap.docs.map(doc => {
                        const d = doc.data();
                        const s = this.toDate(d.login_time);
                        const e = this.toDate(d.logout_time);
                        let dur = 0;
                        // FIX: Calc duration active vs closed
                        if (s && e) dur = (e - s) / 3600000;
                        else if (s) dur = (now - s) / 3600000; // Show progress for active trip
                        return { id: doc.id, ...d, duration: dur };
                    });
                },
                async saveDriver() {
                    if(!this.selectedDriverId) return;
                    await db.collection(COLLECTIONS.ROSTER).doc(this.selectedDriverId).set({
                        name: this.editForm.name,
                        vehicle: this.editForm.vehicle,
                        alert_note: this.editForm.note,
                        default_region: this.editForm.region
                    }, { merge: true });
                    alert("Saved");
                },
                async forceSignOut() {
                    if(confirm("Sign out driver?")) await db.collection(COLLECTIONS.ACTIVE).doc(this.selectedDriverId).delete();
                },
                async saveHistoryNote(tripId, note) {
                    await db.collection(COLLECTIONS.ROSTER).doc(this.selectedDriverId)
                        .collection("shiftHistory").doc(tripId).update({ note: note });
                },
                async saveRegion() {
                    if(this.newRegion.id && this.newRegion.name) {
                        await db.collection(COLLECTIONS.REGIONS).doc(this.newRegion.id).set({
                            name: this.newRegion.name, created_at: new Date()
                        });
                        this.regionModalOpen = false;
                        this.newRegion = {id:'', name:''};
                    }
                },
                async deleteRegion(id) {
                    if(confirm("Delete region?")) await db.collection(COLLECTIONS.REGIONS).doc(id).delete();
                },

                // EXPORT
                async generateDailyReport() {
                    this.isExporting = true;
                    const { start, end } = this.getLocalDayRange(this.exportForm.dailyDate);
                    const regionFilter = this.exportForm.dailyRegion;
                    let csvContent = "Driver Name,Driver ID,Vehicle,Region,Login,Logout,Hours,Notes\n";
                    
                    const promises = this.roster.map(async (driver) => {
                        const snap = await db.collection(COLLECTIONS.ROSTER).doc(driver.id)
                            .collection("shiftHistory").get(); 
                        snap.docs.forEach(doc => {
                            const d = doc.data();
                            const login = this.toDate(d.login_time);
                            const logout = this.toDate(d.logout_time);
                            if(login && login >= start && login <= end) {
                                const rID = this.getDriverRegionID(d);
                                if(regionFilter === 'All' || rID === regionFilter) {
                                    const dur = logout ? (logout - login)/3600000 : 0;
                                    csvContent += `"${driver.name||driver.id}","${driver.id}","${d.vehicle||''}","${this.getRegionName(rID)}","${login.toLocaleString()}","${logout ? logout.toLocaleString() : 'Active'}","${dur.toFixed(2)}","${d.note||''}"\n`;
                                }
                            }
                        });
                    });
                    await Promise.all(promises);
                    this.downloadCSV(csvContent, `Daily_Log_${this.exportForm.dailyDate}.csv`);
                    this.isExporting = false;
                },
                async generateDriverReport() {
                    this.isExporting = true;
                    const { start } = this.getLocalDayRange(this.exportForm.startDate);
                    const { end } = this.getLocalDayRange(this.exportForm.endDate);
                    const snap = await db.collection(COLLECTIONS.ROSTER).doc(this.exportForm.driverId).collection("shiftHistory").get();
                    let csvContent = "Date,Vehicle,Region,Start,End,Hours,Notes\n";
                    snap.docs.forEach(doc => {
                        const d = doc.data();
                        const login = this.toDate(d.login_time);
                        const logout = this.toDate(d.logout_time);
                        if(login && login >= start && login <= end) {
                            const dur = logout ? (logout - login)/3600000 : 0;
                            csvContent += `"${login.toLocaleDateString()}","${d.vehicle||''}","${this.getRegionName(this.getDriverRegionID(d))}","${login.toLocaleTimeString()}","${logout?logout.toLocaleTimeString():'Active'}","${dur.toFixed(2)}","${d.note||''}"\n`;
                        }
                    });
                    this.downloadCSV(csvContent, `Driver_History_${this.exportForm.driverId}.csv`);
                    this.isExporting = false;
                },
                getLocalDayRange(dateStr) {
                    const parts = dateStr.split('-');
                    const y = parseInt(parts[0]), m = parseInt(parts[1])-1, d = parseInt(parts[2]);
                    return { start: new Date(y, m, d, 0,0,0,0), end: new Date(y, m, d, 23,59,59,999) };
                },
                downloadCSV(content, filename) {
                    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                }
            }
        }
    </script>
</body>
</html>
